考虑生成一张 $K$ 行 $N$ 列的矩阵，第 $i$ 行填上 $b_i$，把它消元成一个简化阶梯形矩阵，去掉全 $0$ 行后即为 $b_1,b_2,\cdots,b_K$ 张成的线性空间对应的简化阶梯形矩阵，该线性空间的秩即为矩阵的行数。接下来只需对于所有包含该线性空间且最大值 $\ge X$ 的线性空间，计算恰好张成它的序列个数之和。

先考虑对于给定的一个线性空间，计算有多少序列 $a_1,a_2,\cdots,a_M$ 的恰好张成它。设该线性空间的秩为 $r$，所求即为有多少 $M$ 行 $r$ 列的矩阵满秩，即要求这 $r$ 列线性无关。所以考虑一列一列地填，第一列的方案数为 $2^M-1$，第二列的方案数为 $2^M-2$，$\cdots$，第 $r$ 列的方案数为 $2^M-2^{r-1}$。因此方案数为 $\prod\limits_{i=0}^{r-1}\left(2^M-2^i\right)$。

回到原问题，可以看成在原矩阵中新增一些主元列，并添加对应的行，这一行在其他主元列的位置上全为 $0$。考虑新增一行对最大值的贡献，如果原本的最大值在这一列上已经是 $1$，则该行对最大值没有贡献，否则最大值需异或上该行的值。

现在考虑 dp 方案数，需要记录的状态有：现在考虑了 $i\sim n-1$ 列，新增了 $j$ 行，当前是否有新增的行对最大值有贡献，当前最大值与 $X$ 的 $i\sim n-1$ 位是否一致。转移时分类讨论即可，细节较多。需要注意到如果一列不是主元列，那么如果有新增的行对最大值有贡献，则各有 $2^{j-1}$ 种方案使得最大值在该列的取值为 $0$ 或 $1$，否则 $2^j$ 种方案中，最大值在该列的取值是固定的。

时间复杂度为 $\mathcal O\left(\dfrac{NK^2}{\omega}+N^2\right)$。
